<head>
    <style>
        html, body, #canvas { margin: 0; padding: 0; width: 100%; height: 100%; display: block; }
        #message {font-family: Consolas; font-size: 1.2em; color:#ccc; background-color:black; font-weight: bold; z-index: 2; position: absolute;}
    </style>
</head>
<body>
    <div id="message"></div>
    <div id="container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js"></script>
    <canvas id="canvas"></canvas>
    <script id="vertexShader" type="x-shader/x-vertex">
        void main() {
            gl_Position = vec4(position, 1.0);
        }
    </script>
    <script id="fragmentShader" type="x-shader/x-fragment">
        uniform vec3        iResolution;
        uniform float       iGlobalTime;
        uniform float       iTimeDelta;
        uniform int         iFrame;
        uniform float       iChannelTime[4];
        uniform vec3        iChannelResolution[4];
        uniform vec4        iMouse;
        uniform sampler2D   iChannel0;
        uniform sampler2D   iChannel1;
        uniform sampler2D   iChannel2;
        uniform sampler2D   iChannel3;
        uniform sampler2D   iChannel4;
        uniform sampler2D   iChannel5;
        uniform sampler2D   iChannel6;
        uniform sampler2D   iChannel7;
        uniform sampler2D   iChannel8;
        uniform sampler2D   iChannel9;

        #define SHADER_TOY
        
        void main() {
            vec2 uv = gl_FragCoord.xy / iResolution.xy;
            gl_FragColor = vec4(texture2D(iChannel0, uv).rgb, 0.0);
            //gl_FragColor = vec4(1., 0., 0., 1.0);
        }
    </script>
    <script id="fsBuf" type="x-shader/x-fragment">
        uniform vec3        iResolution;
        uniform float       iGlobalTime;
        uniform float       iTimeDelta;
        uniform int         iFrame;
        uniform float       iChannelTime[4];
        uniform vec3        iChannelResolution[4];
        uniform vec4        iMouse;
        uniform sampler2D   iChannel0;
        uniform sampler2D   iChannel1;
        uniform sampler2D   iChannel2;
        uniform sampler2D   iChannel3;
        uniform sampler2D   iChannel4;
        uniform sampler2D   iChannel5;
        uniform sampler2D   iChannel6;
        uniform sampler2D   iChannel7;
        uniform sampler2D   iChannel8;
        uniform sampler2D   iChannel9;      

        #define SHADER_TOY        
        
        void main() {
            float time=iGlobalTime*1.0;
            vec2 uv = (gl_FragCoord.xy / iResolution.xx-0.5)*8.0;
            vec2 uv0=uv;
            float i0=.8;
            float i1=.8;
            float i2=.75;
            float i4=0.;
            for(int s=0;s<7;s++) {
                vec2 r;
                r=vec2(cos(uv.y*i0-i4-time/i1),sin(uv.x*i0-i4+time/i1))/i2;
                r+=vec2(-r.y,r.x)*0.3;
                uv.xy+=r;
                i0*=1.93;
                i1*=1.15;
                i2*=1.7;
                i4+=0.05+0.1*time*i1;
            }
            float b=sin(uv.x-time)*0.5+0.5;
            float r=sin(uv.y+time)*0.5+0.5;
            float g=sin((uv.x+uv.y+sin(time*0.5))*0.5)*0.5+0.5;
            gl_FragColor = vec4(r,g,b,1.);
        }
    </script>
    <script type="text/javascript">
        (function() {
            var script = document.createElement('script')
            script.onload = function() {
                var stats = new Stats();
			    stats.showPanel(1);
                document.body.appendChild(stats.dom);
                requestAnimationFrame(function loop() {
                    stats.update();
                    requestAnimationFrame(loop);
                });
            };
            script.src = 'https://rawgit.com/mrdoob/stats.js/master/build/stats.min.js';
            document.head.appendChild(script);
        }());
    
        (function(){
            console.error = function (message) {
                if('7' in arguments) {
                    $("#message").html("<h3>Shader failed to compile</h3><ul>")                                    
                    $("#message").append(arguments[7].replace(/ERROR: \d+:(\d+)/g, function(m, c) { return  "<li>Line " + String(Number(c) - 120); }));
                    $("#message").append("</ul>");
                }
            };
        })();

        var canvas = document.getElementById('canvas');
        var renderer = new THREE.WebGLRenderer({canvas: canvas, antialias: true});
        var camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientWidth, 1, 1000);
        var clock = new THREE.Clock();
        var resolution = new THREE.Vector3(canvas.clientWidth, canvas.clientHeight, 1.0);
        var channelResolution = new THREE.Vector3(128.0, 128.0, 0.0);
        var mouse = new THREE.Vector4(0, 0, 0, 0);
        var frameCounter = 0;

        var buffers = [];
        buffers.push({
            target: new THREE.WebGLRenderTarget(canvas.clientWidth, canvas.clientHeight),
            shader: new THREE.ShaderMaterial({
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fsBuf').textContent,
                depthWrite: false,
                depthTest: false,
                uniforms: {
                    iResolution: { type: "v3", value: resolution },
                    iGlobalTime: { type: "f", value: 0.0 },
                    iTimeDelta: { type: "f", value: 0.0 },
                    iFrame: { type: "i", value: 0 },
                    iMouse: { type: "v4", value: mouse },
                }
            })
        });
        buffers.push({
            target: null,
            shader: new THREE.ShaderMaterial({
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent,
                depthWrite: false,
                depthTest: false,
                uniforms: {
                    iResolution: { type: "v3", value: resolution },
                    iGlobalTime: { type: "f", value: 0.0 },
                    iTimeDelta: { type: "f", value: 0.0 },
                    iFrame: { type: "i", value: 0 },
                    iMouse: { type: "v4", value: mouse },
                }
            })
        });

        buffers[1].shader.uniforms.iChannel0 = { type: 't', value: buffers[0].target.texture };
        
        var scene = new THREE.Scene();
        var quad = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 2),
            null
        );
        scene.add(quad);

        camera.position.z = 10;
        render();
        function render() {
            requestAnimationFrame(render);
            if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
                for (let i in buffers) {
                    if (buffers[i].target) {
                        buffers[i].target.setSize(canvas.clientWidth, canvas.clientHeight);
                    }
                }
                renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
                camera.aspect = canvas.clientWidth /  canvas.clientHeight;
                camera.updateProjectionMatrix();
                resolution = new THREE.Vector3(canvas.clientWidth, canvas.clientHeight, 1.0);
            }
            
            frameCounter++;
            var deltaTime = clock.getDelta();
            var time = clock.getElapsedTime();
            
            for (let i in buffers) {
                let buffer = buffers[i];
                buffer.shader.uniforms['iResolution'].value = resolution;
                buffer.shader.uniforms['iTimeDelta'].value = deltaTime;
                buffer.shader.uniforms['iGlobalTime'].value = time;
                buffer.shader.uniforms['iFrame'].value = frameCounter;
                buffer.shader.uniforms['iMouse'].value = mouse;
                quad.material = buffer.shader;
                renderer.render(scene, camera, buffer.target);
            }
        }
        canvas.addEventListener('mousemove', function(evt) {
            if (mouse.z + mouse.w != 0) {
                var rect = canvas.getBoundingClientRect();
                mouse.x = evt.clientX - rect.left;
                mouse.y = resolution.y - evt.clientY - rect.top;
            } 
        }, false);
        canvas.addEventListener('mousedown', function(evt) {
            if (evt.button == 0)
                mouse.z = 1;
            if (evt.button == 2)
                mouse.w = 1;
        }, false);
        canvas.addEventListener('mouseup', function(evt) {
            if (evt.button == 0)
                mouse.z = 0;
            if (evt.button == 2)
                mouse.w = 0;
        }, false);
    </script>
</body>
